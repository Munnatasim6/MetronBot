services:
  # üß† Backend (FastAPI) - ‡ßß.‡ß´ ‡¶ú‡¶ø‡¶¨‡¶ø
  backend:
    build: ./backend
    container_name: metron_brain
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
    environment:
      - DATABASE_URL=postgresql://metron_user:secretpassword@db:5432/metron_db
    depends_on:
      - db
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1.5G # ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡ßß.‡ß´ ‡¶ú‡¶ø‡¶¨‡¶ø ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü

  # üé® Frontend (React/Vite) - ‡ß®.‡ß´ ‡¶ú‡¶ø‡¶¨‡¶ø
  frontend:
    build:
      context: ./Frontend
      dockerfile: Dockerfile.dev
    container_name: metron_ui
    ports:
      - "5173:5173"
    volumes:
      - ./Frontend:/app # ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶ï‡ßã‡¶° ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
      - /app/node_modules # ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶ø‡¶ú‡¶∏‡ßç‡¶¨ ‡¶Æ‡¶°‡¶ø‡¶â‡¶≤ ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞
    # üëá ‡¶è‡¶á ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶°‡¶ü‡¶ø ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶≤‡¶ø‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏‡¶ø ‡¶Æ‡ßã‡¶°‡ßá ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤ ‡¶ï‡¶∞‡¶¨‡ßá
    command: >
      sh -c " if [ ! -f package.json ]; then echo '‚ö†Ô∏è package.json not found! Check volume mount.'; fi && npm install --legacy-peer-deps && npm run dev -- --host "
    environment:
      - VITE_API_URL=http://localhost:8000
    depends_on:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2.5G # ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡ß®.‡ß´ ‡¶ú‡¶ø‡¶¨‡¶ø ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü

  # üóÑÔ∏è Database (TimescaleDB) - ‡ßß.‡ß´ ‡¶ú‡¶ø‡¶¨‡¶ø
  db:
    image: timescale/timescaledb:latest-pg14
    container_name: metron_db
    restart: always
    environment:
      - POSTGRES_USER=metron_user
      - POSTGRES_PASSWORD=secretpassword
      - POSTGRES_DB=metron_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 1.5G # ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡ßß.‡ß´ ‡¶ú‡¶ø‡¶¨‡¶ø ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü

volumes:
  postgres_data:
